name: Test CI/CD Configuration

on:
  workflow_dispatch:
  pull_request:
    paths:
      - '.github/workflows/**'
      - 'Dockerfile'
      - 'requirements*.txt'

jobs:
  validate-workflows:
    name: Validate Workflow Files
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate workflow syntax
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            const yaml = require('js-yaml');
            
            const workflowsDir = '.github/workflows';
            const workflowFiles = fs.readdirSync(workflowsDir)
              .filter(f => f.endsWith('.yml') || f.endsWith('.yaml'));
            
            console.log(`Found ${workflowFiles.length} workflow files`);
            
            const errors = [];
            
            for (const file of workflowFiles) {
              try {
                const filePath = path.join(workflowsDir, file);
                const content = fs.readFileSync(filePath, 'utf8');
                const workflow = yaml.load(content);
                
                // 基本验证
                if (!workflow.name) {
                  errors.push(`${file}: Missing 'name' field`);
                }
                
                if (!workflow.on) {
                  errors.push(`${file}: Missing 'on' trigger`);
                }
                
                if (!workflow.jobs || Object.keys(workflow.jobs).length === 0) {
                  errors.push(`${file}: No jobs defined`);
                }
                
                console.log(`✅ ${file}: Valid`);
              } catch (error) {
                errors.push(`${file}: ${error.message}`);
              }
            }
            
            if (errors.length > 0) {
              console.error('Validation errors:');
              errors.forEach(e => console.error(`  - ${e}`));
              throw new Error('Workflow validation failed');
            }

  validate-dockerfile:
    name: Validate Dockerfile
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate Dockerfile syntax
        run: |
          if [ ! -f Dockerfile ]; then
            echo "❌ Dockerfile not found"
            exit 1
          fi
          
          # 基本语法检查
          echo "Checking Dockerfile..."
          
          # 检查必要的指令
          if ! grep -q "FROM" Dockerfile; then
            echo "❌ Dockerfile missing FROM instruction"
            exit 1
          fi
          
          if ! grep -q "WORKDIR" Dockerfile; then
            echo "⚠️ Dockerfile missing WORKDIR instruction (recommended)"
          fi
          
          echo "✅ Dockerfile syntax looks good"

  validate-requirements:
    name: Validate Requirements Files
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Validate requirements.txt
        run: |
          if [ -f requirements.txt ]; then
            echo "Validating requirements.txt..."
            python -m pip install --upgrade pip
            pip install pipdeptree
            
            # 尝试解析依赖
            pip install --dry-run -r requirements.txt 2>&1 | head -20 || true
            
            echo "✅ requirements.txt validated"
          else
            echo "⚠️ requirements.txt not found"
          fi

      - name: Validate requirements-dev.txt
        run: |
          if [ -f requirements-dev.txt ]; then
            echo "Validating requirements-dev.txt..."
            pip install --dry-run -r requirements-dev.txt 2>&1 | head -20 || true
            echo "✅ requirements-dev.txt validated"
          else
            echo "⚠️ requirements-dev.txt not found"
          fi

  test-build:
    name: Test Docker Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Test Docker build (dry run)
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64
          push: false
          target: builder
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Verify Dockerfile stages
        run: |
          echo "Checking Dockerfile stages..."
          STAGES=$(grep -c "^FROM.*as" Dockerfile || echo "0")
          echo "Found $STAGES multi-stage build stages"
          
          if grep -q "FROM.*as builder" Dockerfile; then
            echo "✅ Builder stage found"
          fi
          
          if grep -q "^FROM.*python" Dockerfile; then
            echo "✅ Python base image found"
          fi

  summary:
    name: Configuration Summary
    runs-on: ubuntu-latest
    needs: [validate-workflows, validate-dockerfile, validate-requirements, test-build]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## CI/CD Configuration Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Workflow Files" >> $GITHUB_STEP_SUMMARY
          ls -1 .github/workflows/*.yml .github/workflows/*.yaml 2>/dev/null | wc -l | xargs -I {} echo "- Found {} workflow files" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Configuration Files" >> $GITHUB_STEP_SUMMARY
          [ -f Dockerfile ] && echo "- ✅ Dockerfile" >> $GITHUB_STEP_SUMMARY || echo "- ❌ Dockerfile" >> $GITHUB_STEP_SUMMARY
          [ -f requirements.txt ] && echo "- ✅ requirements.txt" >> $GITHUB_STEP_SUMMARY || echo "- ❌ requirements.txt" >> $GITHUB_STEP_SUMMARY
          [ -f requirements-dev.txt ] && echo "- ✅ requirements-dev.txt" >> $GITHUB_STEP_SUMMARY || echo "- ⚠️ requirements-dev.txt (optional)" >> $GITHUB_STEP_SUMMARY
          [ -f .github/dependabot.yml ] && echo "- ✅ Dependabot config" >> $GITHUB_STEP_SUMMARY || echo "- ⚠️ Dependabot config (optional)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Results" >> $GITHUB_STEP_SUMMARY
          echo "- Workflow Validation: ${{ needs.validate-workflows.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Dockerfile Validation: ${{ needs.validate-dockerfile.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Requirements Validation: ${{ needs.validate-requirements.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Docker Build Test: ${{ needs.test-build.result }}" >> $GITHUB_STEP_SUMMARY
