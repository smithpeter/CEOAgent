name: Rollback Deployment

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - development
          - production
      revision:
        description: 'Revision number to rollback to (leave empty for previous)'
        required: false
        type: string

jobs:
  rollback:
    name: Rollback ${{ inputs.environment }}
    runs-on: ubuntu-latest
    environment:
      name: ${{ inputs.environment }}
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'

      - name: Configure kubectl
        run: |
          mkdir -p $HOME/.kube
          if [ "${{ inputs.environment }}" == "production" ]; then
            echo "${{ secrets.KUBECONFIG_PROD }}" | base64 -d > $HOME/.kube/config
          else
            echo "${{ secrets.KUBECONFIG_DEV }}" | base64 -d > $HOME/.kube/config
          fi
          chmod 600 $HOME/.kube/config

      - name: Get namespace
        id: namespace
        run: |
          if [ "${{ inputs.environment }}" == "production" ]; then
            echo "namespace=ceoagent" >> $GITHUB_OUTPUT
          else
            echo "namespace=ceoagent-dev" >> $GITHUB_OUTPUT
          fi

      - name: Show deployment history
        run: |
          echo "Deployment history:"
          kubectl rollout history deployment/ceoagent-api -n ${{ steps.namespace.outputs.namespace }}

      - name: Rollback deployment
        run: |
          if [ -n "${{ inputs.revision }}" ]; then
            echo "Rolling back to revision ${{ inputs.revision }}"
            kubectl rollout undo deployment/ceoagent-api \
              --to-revision=${{ inputs.revision }} \
              -n ${{ steps.namespace.outputs.namespace }}
          else
            echo "Rolling back to previous revision"
            kubectl rollout undo deployment/ceoagent-api \
              -n ${{ steps.namespace.outputs.namespace }}
          fi

      - name: Wait for rollout
        run: |
          kubectl rollout status deployment/ceoagent-api \
            -n ${{ steps.namespace.outputs.namespace }} \
            --timeout=5m

      - name: Verify rollback
        run: |
          echo "Current deployment status:"
          kubectl get deployment ceoagent-api -n ${{ steps.namespace.outputs.namespace }}
          kubectl get pods -l app=ceoagent-api -n ${{ steps.namespace.outputs.namespace }}
          
          echo "Deployment history after rollback:"
          kubectl rollout history deployment/ceoagent-api -n ${{ steps.namespace.outputs.namespace }}

      - name: Health check
        run: |
          POD_NAME=$(kubectl get pod -l app=ceoagent-api -n ${{ steps.namespace.outputs.namespace }} -o jsonpath='{.items[0].metadata.name}')
          if [ -z "${POD_NAME}" ]; then
            echo "⚠️ No pod found for health check"
            exit 0
          fi
          
          sleep 10
          if kubectl exec -n ${{ steps.namespace.outputs.namespace }} "${POD_NAME}" -- \
            python -c "import httpx; httpx.get('http://localhost:8000/api/v1/health', timeout=5)" 2>/dev/null || \
            kubectl exec -n ${{ steps.namespace.outputs.namespace }} "${POD_NAME}" -- \
            python -c "import httpx; httpx.get('http://localhost:8000/health', timeout=5)" 2>/dev/null; then
            echo "✅ Health check passed after rollback"
          else
            echo "⚠️ Health check failed after rollback"
            kubectl logs -n ${{ steps.namespace.outputs.namespace }} "${POD_NAME}" --tail=30
          fi

      - name: Notify rollback
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: |
            Rollback to ${{ inputs.environment }} environment ${{ job.status }}
            Revision: ${{ inputs.revision || 'previous' }}
            Triggered by: ${{ github.actor }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
        continue-on-error: true
